<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Philatelic Sleuth | India Post Data</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #0f172a; color: #f1f5f9; font-family: 'Inter', system-ui, sans-serif; }
.search-focus:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #1e3a8a; }
.loader-spin { border: 3px solid #1e293b; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.chip { background-color: #1e293b; border: 1px solid #334155; }

/* Dark Thin Scrollbar */
* { scrollbar-width: thin; scrollbar-color: #334155 #1e293b; }
*::-webkit-scrollbar { width: 6px; height: 6px; }
*::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
*::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; border: 1px solid #1e293b; }
*::-webkit-scrollbar-thumb:hover { background: #475569; }
.overflow-x-auto { scrollbar-width: thin; scrollbar-color: #334155 #1e293b; }

/* Sort arrow */
.sort-arrow::after {
    content: "↕";
    margin-left: 6px;
    font-size: 10px;
    opacity: 0.5;
}
.sort-arrow.asc::after { content: "↑"; opacity: 1; color: #60a5fa; }
.sort-arrow.desc::after { content: "↓"; opacity: 1; color: #60a5fa; }
</style>
</head>
<body class="p-4 md:p-10">

<!-- Loader -->
<div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a]">
    <div class="loader-spin mb-4"></div>
    <p class="text-[10px] font-mono text-slate-500 uppercase tracking-[0.2em]">
        Streaming All-India Database...
    </p>
</div>

<div class="max-w-7xl mx-auto">

<!-- Header with Search Bar -->
<header class="mb-10 border-b border-slate-800 pb-8">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">
                Philatelic <span class="text-blue-500 italic">Sleuth</span>
            </h1>
            <p class="text-slate-500 text-[10px] uppercase font-black tracking-[0.3em] mt-1">
                Social Philately Research Engine
            </p>
        </div>

        <!-- Search Bar -->
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="relative flex-1 md:flex-initial">
                <input id="search-q"
                       type="text"
                       placeholder="Search anything... (use ? and *)"
                       onkeyup="if(event.key==='Enter') startResearch()"
                       class="w-full md:w-96 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 pr-10 text-sm search-focus outline-none text-white font-medium">
                <button id="clear-search" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white text-lg hidden">&times;</button>
            </div>
            <button onclick="startResearch()"
                    class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded-xl font-black text-[10px] uppercase tracking-[0.2em]">
                Search
            </button>
            <button onclick="clearAllFilters()"
                    class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-xl font-black text-[9px] uppercase tracking-[0.2em]">
                Clear All
            </button>
        </div>
    </div>

    <!-- Active Anchors -->
    <div id="anchors-container" class="flex flex-wrap gap-2 mt-6"></div>
</header>

<!-- Results Table -->
<div class="bg-slate-900/30 border border-slate-800 rounded-3xl overflow-hidden">
    <div class="overflow-x-auto h-[78vh]">
        <table class="w-full text-left text-xs border-collapse">
            <thead class="bg-slate-800 text-slate-500 uppercase text-[9px] font-black tracking-widest sticky top-0 z-10">
                <tr>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('officename')">Post Office</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('officetype')">Office Type</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('delivery')">Delivery</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('pincode')">Pincode</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('district')">District</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('statename')">State</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('divisionname')">Division</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('regionname')">Region</th>
                    <th class="px-6 py-4 cursor-pointer sort-arrow" onclick="sortTable('circlename')">Circle</th>
                </tr>
            </thead>
            <tbody id="results-table">
                <tr>
                    <td colspan="9" class="p-20 text-center text-slate-600 italic">
                        Dataset loaded. No search yet.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="meta-info" class="mt-6 text-center font-mono text-[9px] text-slate-600 uppercase tracking-widest"></div>

</div>

<script>
let POSTAL_DATA = [];
let ACTIVE_ANCHORS = []; // Multiple exact substring anchors (AND logic)
let currentSort = { key: null, direction: 'asc' };

const VALID_FIELDS = ['circlename', 'regionname', 'divisionname', 'officename', 'pincode', 'officetype', 'delivery', 'district', 'statename'];

// CSV load
Papa.parse("data.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: res => {
        POSTAL_DATA = res.data;
        document.getElementById('loader').classList.add('hidden');
        startResearch();
    }
});

// Only include allowed fields in search text
const rowText = row => {
    if (!row) return '';
    let parts = [];
    for (const field of VALID_FIELDS) {
        if (row[field]) parts.push(row[field].toString().trim());
    }
    return parts.join(" ").toUpperCase();
};

// Wildcard → RegExp
function queryToRegex(q) {
    if (!q) return null;
    let pattern = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    pattern = pattern.replace(/\\\*/g, '.*').replace(/\\\?/g, '.');
    try { return new RegExp(pattern, 'i'); } catch (e) { return null; }
}

// Clickable tag — only for valid fields
function tag(field, val) {
    if (!val || !VALID_FIELDS.includes(field)) return val || '';
    const display = val.toString().trim();
    const safe = display.replace(/'/g, "\\'");
    const upper = display.toUpperCase();
    return `<span class="cursor-pointer hover:text-blue-300"
                  onclick="addAnchor('${safe}', '${upper}')">${display}</span>`;
}

// Anchor controls
window.addAnchor = (display, upper) => {
    if (ACTIVE_ANCHORS.includes(upper)) return;
    ACTIVE_ANCHORS.push(upper);
    renderAnchors();
    startResearch();
};

window.removeAnchor = index => {
    ACTIVE_ANCHORS.splice(index, 1);
    renderAnchors();
    startResearch();
};

window.clearAllFilters = () => {
    document.getElementById('search-q').value = '';
    document.getElementById('clear-search').classList.add('hidden');
    ACTIVE_ANCHORS = [];
    renderAnchors();
    startResearch();
};

function renderAnchors() {
    const container = document.getElementById('anchors-container');
    if (ACTIVE_ANCHORS.length === 0) {
        container.innerHTML = '';
        return;
    }
    container.innerHTML = ACTIVE_ANCHORS.map((a, i) => `
        <div class="chip px-3 py-2 rounded-full flex items-center gap-2 text-xs font-medium text-slate-200">
            <span>${a}</span>
            <button onclick="removeAnchor(${i})" class="text-slate-400 hover:text-white text-lg leading-none">&times;</button>
        </div>
    `).join('');
}

// Sorting
window.sortTable = key => {
    if (currentSort.key === key) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort = { key, direction: 'asc' };
    }
    document.querySelectorAll('th.sort-arrow').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    event.target.classList.add(currentSort.direction);
    startResearch();
};

// Clear button inside search
document.getElementById('search-q').addEventListener('input', function() {
    const clearBtn = document.getElementById('clear-search');
    if (this.value) clearBtn.classList.remove('hidden');
    else clearBtn.classList.add('hidden');
});
document.getElementById('clear-search').addEventListener('click', () => {
    document.getElementById('search-q').value = '';
    document.getElementById('clear-search').classList.add('hidden');
    startResearch();
});

// Main research
window.startResearch = () => {
    const qInput = document.getElementById('search-q').value.trim().toUpperCase();
    const regex = queryToRegex(qInput);

    const t0 = performance.now();
    let results = POSTAL_DATA.filter(r => {
        const txt = rowText(r);

        // All anchors must be present
        for (const anchor of ACTIVE_ANCHORS) {
            if (!txt.includes(anchor)) return false;
        }

        // Wildcard search
        if (regex && !regex.test(txt)) return false;

        return true;
    });

    // Apply sorting
    if (currentSort.key) {
        results.sort((a, b) => {
            let A = (a[currentSort.key] || '').toString().toUpperCase();
            let B = (b[currentSort.key] || '').toString().toUpperCase();
            if (currentSort.key === 'pincode') {
                A = parseInt(A) || 0;
                B = parseInt(B) || 0;
            }
            if (A < B) return currentSort.direction === 'asc' ? -1 : 1;
            if (A > B) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    render(results.slice(0, 1000));
    const time = (performance.now() - t0).toFixed(1);
    document.getElementById('meta-info').innerText =
        `${results.length} matches in ${time} ms`;
};

// Render single-line rows
function render(rows) {
    const body = document.getElementById('results-table');
    if (!rows.length) {
        body.innerHTML = `<tr><td colspan="9" class="p-20 text-center text-slate-700 font-bold uppercase">NO RESULTS</td></tr>`;
        return;
    }
    body.innerHTML = rows.map(r => `
<tr class="hover:bg-blue-500/5 transition-colors border-b border-slate-800/50">
    <td class="px-6 py-4"><span class="font-black text-blue-400">${tag('officename', r.officename)}</span></td>
    <td class="px-6 py-4 text-slate-400">${tag('officetype', r.officetype)}</td>
    <td class="px-6 py-4 text-slate-400">${tag('delivery', r.delivery)}</td>
    <td class="px-6 py-4 text-center font-mono text-blue-100 font-black">${tag('pincode', r.pincode)}</td>
    <td class="px-6 py-4">${tag('district', r.district)}</td>
    <td class="px-6 py-4">${tag('statename', r.statename)}</td>
    <td class="px-6 py-4">${tag('divisionname', r.divisionname)}</td>
    <td class="px-6 py-4">${tag('regionname', r.regionname)}</td>
    <td class="px-6 py-4">${tag('circlename', r.circlename)}</td>
</tr>
`).join('');
}
</script>

</body>
</html>
