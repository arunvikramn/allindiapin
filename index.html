<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philatelic Sleuth | India Post Data</title>
    <script src="https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/dist/duckdb-wasm-browser.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(8px); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a] transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-sm font-bold tracking-[0.3em] text-blue-400 uppercase">Sleuth Engine Warming Up</h2>
        <p id="status" class="text-slate-500 text-[10px] mt-4 font-mono text-center max-w-xs leading-relaxed italic">Initializing Data Workers...</p>
    </div>

    <header class="border-b border-slate-800 p-4 glass sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-1.5 rounded shadow-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                </div>
                <h1 class="font-bold text-sm text-white">Philatelic Sleuth <span class="text-blue-500 ml-2 text-[10px] opacity-50 underline">GitHub Edition</span></h1>
            </div>
            <div id="anchor-display" class="hidden items-center gap-2 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/30">
                <span class="text-[9px] font-bold text-blue-400 uppercase tracking-tighter">Anchor:</span>
                <span id="anchor-name" class="text-[11px] font-semibold text-blue-100 italic"></span>
                <button onclick="window.clearAnchor()" class="text-slate-500 hover:text-white ml-2">✕</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 p-6">
        <aside class="lg:col-span-3 space-y-4">
            <div class="bg-slate-800/40 border border-slate-700 p-5 rounded-xl space-y-5">
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase mb-2 block">Name Search</label>
                    <input type="text" id="search" placeholder="e.g. Kothimir" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none transition">
                </div>

                <div class="space-y-2">
                    <label class="flex items-center justify-between text-[11px] text-slate-400">
                        <span>Fuzzy Tolerance</span>
                        <input type="checkbox" id="f_fuzzy" class="rounded bg-slate-900 border-slate-700">
                    </label>
                    <input type="range" id="f_fuzzy_val" min="50" max="100" value="80" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="grid grid-cols-2 gap-2 text-[9px] font-bold">
                    <label class="flex items-center gap-2 p-2 rounded bg-slate-900 border border-slate-700 cursor-pointer hover:border-blue-500">
                        <input type="checkbox" id="f_district"> DISTRICT
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded bg-slate-900 border border-slate-700 cursor-pointer hover:border-blue-500">
                        <input type="checkbox" id="f_division"> DIVISION
                    </label>
                </div>

                <div class="border-t border-slate-700 pt-4">
                    <label class="flex items-center gap-2 text-[11px] text-slate-400 mb-2">
                        <input type="checkbox" id="f_nearby"> Show Nearby POs
                    </label>
                    <select id="f_radius" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-slate-300">
                        <option value="5">Within 5 km</option>
                        <option value="25">Within 25 km</option>
                        <option value="100">Within 100 km</option>
                    </select>
                </div>

                <button id="btnSearch" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-xs uppercase tracking-widest transition shadow-lg shadow-blue-900/20">Analyze Records</button>
            </div>
            <div id="stats" class="text-[9px] text-slate-600 font-mono text-center tracking-tight"></div>
        </aside>

        <section class="lg:col-span-9 bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden shadow-2xl flex flex-col">
            <div class="overflow-x-auto custom-scrollbar h-[70vh]">
                <table class="w-full text-left text-xs whitespace-nowrap border-collapse">
                    <thead class="bg-slate-800/90 text-slate-500 uppercase tracking-tighter sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-4 border-b border-slate-700">Name / Beat Context</th>
                            <th class="px-4 py-4 border-b border-slate-700">Location</th>
                            <th class="px-4 py-4 border-b border-slate-700 text-center">PIN</th>
                            <th class="px-4 py-4 border-b border-slate-700 text-right">Distance</th>
                        </tr>
                    </thead>
                    <tbody id="results" class="divide-y divide-slate-800/50">
                        <tr><td colspan="4" class="p-20 text-center text-slate-600 italic">Enter a PO name to begin your sleuthing...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // Using window.duckdb because we are using the UMD script tag
        let db, conn, anchorPoint = null;

        async function init() {
            const statusLabel = document.getElementById('status');
            try {
                if (typeof duckdb === 'undefined') throw new Error("DuckDB library blocked by browser.");

                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                
                statusLabel.innerText = "Spawning Web Workers...";
                const worker_url = URL.createObjectURL(new Blob([`importScripts("${bundle.mainWorker}");`], {type: 'text/javascript'}));
                const worker = new Worker(worker_url);
                
                db = new duckdb.AsyncDuckDB(new duckdb.ConsoleLogger(), worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                
                statusLabel.innerText = "Indexing 22MB Dataset...";
                await db.registerFileURL('data.csv', './data.csv', duckdb.DuckDBDataProtocol.HTTP, false);
                
                conn = await db.connect();
                await conn.query(`
                    CREATE TABLE pos AS SELECT * FROM read_csv_auto('data.csv', ignore_errors=true);
                    UPDATE pos SET latitude = NULL WHERE CAST(latitude AS VARCHAR) = 'NA';
                    UPDATE pos SET longitude = NULL WHERE CAST(longitude AS VARCHAR) = 'NA';
                `);

                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => document.getElementById('loading').remove(), 500);
            } catch (err) {
                statusLabel.innerHTML = `<span class="text-red-500 font-bold uppercase">System Blocked</span><br><span class="text-[10px] text-slate-400 underline">${err.message}</span><br><br>Try using Chrome or Firefox.`;
                console.error("Critical Engine Failure:", err);
            }
        }

        window.runSearch = async function() {
            const term = document.getElementById('search').value.trim().toUpperCase();
            const fuzzy = document.getElementById('f_fuzzy').checked;
            const threshold = document.getElementById('f_fuzzy_val').value;
            
            let query = `SELECT *, 0 as dist FROM pos WHERE 1=1 `;
            
            if (term) {
                if (fuzzy) {
                    query += ` AND (100 - (levenshtein(UPPER(officename), '${term}') / length(UPPER(officename)) * 100)) >= ${threshold}`;
                } else {
                    query += ` AND UPPER(officename) LIKE '%${term}%'`;
                }
            }

            if (anchorPoint) {
                if (document.getElementById('f_district').checked) query += ` AND district = '${anchorPoint.district}'`;
                if (document.getElementById('f_division').checked) query += ` AND divisionname = '${anchorPoint.divisionname}'`;
                
                if (document.getElementById('f_nearby').checked && anchorPoint.latitude) {
                    const r = document.getElementById('f_radius').value;
                    query = `SELECT *, sqrt(pow(latitude - ${anchorPoint.latitude}, 2) + pow(longitude - ${anchorPoint.longitude}, 2)) * 111 as dist 
                             FROM (${query}) WHERE dist <= ${r}`;
                }
            }

            query += ` ORDER BY dist ASC LIMIT 1000`;
            const start = performance.now();
            const results = await conn.query(query);
            render(results.toArray());
            document.getElementById('stats').innerText = `${results.numRows} POs found in ${(performance.now()-start).toFixed(2)}ms`;
        }

        function render(rows) {
            const tbody = document.getElementById('results');
            if(rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-500 italic">No matching records found.</td></tr>';
                return;
            }
            tbody.innerHTML = rows.map(row => `
                <tr class="hover:bg-blue-500/5 cursor-pointer transition group" onclick="window.setAnchor(${JSON.stringify(row).replace(/'/g, "&apos;")})">
                    <td class="px-4 py-3 border-b border-slate-800/50">
                        <div class="font-bold text-blue-400 group-hover:text-blue-300 transition-colors">${row.officename}</div>
                        <div class="text-[9px] text-slate-500 uppercase font-semibold tracking-tighter">${row.officetype} • ${row.statename}</div>
                    </td>
                    <td class="px-4 py-3 border-b border-slate-800/50 text-slate-400">
                        <div class="text-[10px] uppercase">${row.district}</div>
                        <div class="text-[9px] opacity-40">${row.divisionname}</div>
                    </td>
                    <td class="px-4 py-3 border-b border-slate-800/50 text-center font-mono text-slate-300 text-[11px]">${row.pincode}</td>
                    <td class="px-4 py-3 border-b border-slate-800/50 text-right font-bold ${row.dist > 0 ? 'text-emerald-500' : 'text-slate-700'}">
                        ${row.dist > 0 ? row.dist.toFixed(1) + ' km' : '-'}
                    </td>
                </tr>
            `).join('');
        }

        window.setAnchor = (row) => {
            anchorPoint = row;
            document.getElementById('anchor-display').classList.replace('hidden', 'flex');
            document.getElementById('anchor-name').innerText = row.officename;
            window.runSearch();
        };

        window.clearAnchor = () => {
            anchorPoint = null;
            document.getElementById('anchor-display').classList.replace('flex', 'hidden');
            window.runSearch();
        };

        document.getElementById('btnSearch').addEventListener('click', window.runSearch);
        window.addEventListener('load', init);
    </script>
</body>
</html>
