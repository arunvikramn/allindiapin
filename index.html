<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Philatelic Sleuth | India Post Data</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #0f172a; color: #f1f5f9; font-family: 'Inter', system-ui, sans-serif; }
.search-focus:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #1e3a8a; }
.loader-spin { border: 3px solid #1e293b; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.chip { background-color: #1e293b; border: 1px solid #334155; }

/* Custom Dark Thin Scrollbar Styling */
* {
    scrollbar-width: thin; /* Firefox: thin scrollbar */
    scrollbar-color: #334155 #1e293b; /* Firefox: thumb slate-700, track slate-900 */
}

*::-webkit-scrollbar {
    width: 6px; /* Thin width */
    height: 6px; /* For horizontal if needed */
}

*::-webkit-scrollbar-track {
    background: #1e293b; /* slate-900 dark track */
    border-radius: 10px;
}

*::-webkit-scrollbar-thumb {
    background: #334155; /* slate-700 thumb */
    border-radius: 10px;
    border: 1px solid #1e293b; /* subtle border for polish */
}

*::-webkit-scrollbar-thumb:hover {
    background: #475569; /* slate-600 on hover */
}

/* Ensure table container scrollbar inherits */
.overflow-x-auto {
    scrollbar-width: thin;
    scrollbar-color: #334155 #1e293b;
}

.overflow-x-auto::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.overflow-x-auto::-webkit-scrollbar-track {
    background: #1e293b;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
    background: #334155;
    border-radius: 10px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #475569;
}
</style>
</head>
<body class="p-4 md:p-10">

<!-- Loader -->
<div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f172a]">
    <div class="loader-spin mb-4"></div>
    <p class="text-[10px] font-mono text-slate-500 uppercase tracking-[0.2em]">
        Streaming All-India Database...
    </p>
</div>

<div class="max-w-7xl mx-auto">

<!-- Header -->
<header class="mb-10 flex flex-col md:flex-row justify-between items-start border-b border-slate-800 pb-8 gap-4">
    <div>
        <h1 class="text-3xl font-bold text-white tracking-tight">
            Philatelic <span class="text-blue-500 italic">Sleuth</span>
        </h1>
        <p class="text-slate-500 text-[10px] uppercase font-black tracking-[0.3em] mt-1">
            Social Philately Research Engine
        </p>
    </div>
    <div id="anchors-container" class="flex flex-wrap gap-2">
        <!-- Active anchor chips will appear here -->
    </div>
</header>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

<!-- Sidebar -->
<aside class="lg:col-span-3">
    <div class="bg-slate-800/30 border border-slate-700 p-6 rounded-3xl space-y-6">
        <div>
            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest">
                Global Search (any field)
            </label>
            <p class="text-[9px] text-slate-600 mt-1 leading-relaxed">
                Supports wildcards: <span class="font-bold text-blue-400">?</span> = one character,
                <span class="font-bold text-blue-400">*</span> = any characters (incl. none).<br>
                Examples: <code class="bg-slate-700 px-1 rounded">BAN*GALORE</code>,
                <code class="bg-slate-700 px-1 rounded">MA?N</code>,
                <code class="bg-slate-700 px-1 rounded">*ROAD*</code>,
                <code class="bg-slate-700 px-1 rounded">400?</code>
            </p>
        </div>
        <input id="search-q"
               type="text"
               placeholder="Type anything... (use ? and *)"
               onkeyup="if(event.key==='Enter') startResearch()"
               class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm search-focus outline-none text-white font-medium">
        <button onclick="startResearch()"
                class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black text-[10px] uppercase tracking-[0.2em]">
            Run Research
        </button>
        <button onclick="clearAllFilters()"
                class="w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl font-black text-[9px] uppercase tracking-[0.2em]">
            Clear All Filters
        </button>
    </div>
    <div id="meta-info"
         class="mt-6 text-center font-mono text-[9px] text-slate-600 uppercase tracking-widest"></div>
</aside>

<!-- Results -->
<section class="lg:col-span-9">
<div class="bg-slate-900/30 border border-slate-800 rounded-3xl overflow-hidden">
<div class="overflow-x-auto h-[70vh]">
<table class="w-full text-left text-xs border-collapse">
<thead class="bg-slate-800 text-slate-500 uppercase text-[9px] font-black tracking-widest sticky top-0">
<tr>
    <th class="px-6 py-5">Post Office</th>
    <th class="px-6 py-5">Administration</th>
    <th class="px-6 py-5 text-center">Pincode</th>
</tr>
</thead>
<tbody id="results-table">
<tr>
    <td colspan="3" class="p-20 text-center text-slate-600 italic">
        Dataset loaded. No search yet.
    </td>
</tr>
</tbody>
</table>
</div>
</div>
</section>

</div>
</div>

<script>
let POSTAL_DATA = [];
let ACTIVE_ANCHORS = []; // Array of exact uppercase strings for AND filtering

// CSV load
Papa.parse("data.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: res => {
        POSTAL_DATA = res.data;
        document.getElementById('loader').classList.add('hidden');
    }
});

// Helper: stringify row for searching â€” EXCLUDES latitude & longitude
const rowText = row => {
    const { latitude, longitude, ...rest } = row || {};
    return Object.values(rest).join(" ").toUpperCase();
};

// Convert wildcard query to RegExp
function queryToRegex(q) {
    if (!q) return null;
    let pattern = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // escape regex specials
    pattern = pattern.replace(/\\\*/g, '.*').replace(/\\\?/g, '.');
    try {
        return new RegExp(pattern, 'i'); // case-insensitive
    } catch (e) {
        return null;
    }
}

// Clickable value wrapper (for adding anchors)
function tag(val) {
    if (!val) return '';
    const display = val.toString().trim();
    const safe = display.replace(/'/g, "\\'");
    const upper = display.toUpperCase();
    return `<span class="cursor-pointer hover:text-blue-300"
                  onclick="addAnchor('${safe}', '${upper}')">${display}</span>`;
}

// Add anchor
window.addAnchor = (display, upper) => {
    if (ACTIVE_ANCHORS.includes(upper)) return; // no duplicates
    ACTIVE_ANCHORS.push(upper);
    renderAnchors();
    startResearch();
};

// Remove specific anchor
window.removeAnchor = index => {
    ACTIVE_ANCHORS.splice(index, 1);
    renderAnchors();
    startResearch();
};

// Clear everything
window.clearAllFilters = () => {
    document.getElementById('search-q').value = '';
    ACTIVE_ANCHORS = [];
    renderAnchors();
    startResearch();
};

// Render anchor chips
function renderAnchors() {
    const container = document.getElementById('anchors-container');
    if (ACTIVE_ANCHORS.length === 0) {
        container.innerHTML = '';
        return;
    }
    container.innerHTML = ACTIVE_ANCHORS.map((a, i) => `
        <div class="chip px-3 py-2 rounded-full flex items-center gap-2 text-xs font-medium text-slate-200">
            <span>${a}</span>
            <button onclick="removeAnchor(${i})" class="text-slate-400 hover:text-white text-lg leading-none">&times;</button>
        </div>
    `).join('');
}

// Main research logic
window.startResearch = () => {
    const qInput = document.getElementById('search-q').value.trim().toUpperCase();
    const regex = queryToRegex(qInput);

    const t0 = performance.now();
    const results = POSTAL_DATA.filter(r => {
        const txt = rowText(r);

        // Must contain ALL active anchors (exact substring match)
        for (const anchor of ACTIVE_ANCHORS) {
            if (!txt.includes(anchor)) return false;
        }

        // If there's a wildcard query, must match the regex
        if (regex && !regex.test(txt)) return false;

        return true;
    });

    render(results.slice(0, 500)); // limit display to 500 rows for performance
    const time = (performance.now() - t0).toFixed(1);
    document.getElementById('meta-info').innerText =
        `${results.length} matches in ${time} ms`;
};

// Render table rows
function render(rows) {
    const body = document.getElementById('results-table');
    if (!rows.length) {
        body.innerHTML = `
            <tr><td colspan="3" class="p-20 text-center text-slate-700 font-bold uppercase">
             NO RESULTS
             </td></tr>`;
        return;
    }
    body.innerHTML = rows.map(r => `
<tr class="hover:bg-blue-500/5 transition-colors">
    <td class="px-6 py-4 space-y-1">
        <div class="font-black text-blue-400">${tag(r.officename)}</div>
        <div class="text-[9px] text-slate-500 uppercase">
            ${tag(r.officetype)} | ${tag(r.statename)}
        </div>
    </td>
    <td class="px-6 py-4 text-[10px] text-slate-400 space-y-1">
        <div>${tag(r.circlename)} - ${tag(r.regionname)}</div>
        <div>${tag(r.divisionname)}</div>
        <div>${tag(r.district)}</div>
    </td>
    <td class="px-6 py-4 text-center font-mono text-blue-100 font-black">
        ${tag(r.pincode)}
    </td>
</tr>
`).join('');
}
</script>

</body>
</html>
